---
title: "Zookeeper 知识点"
description: "Zookeeper知识点概要总结"
date: 2022-01-16T17:51:01+08:00
draft: false
categories: ["zookeeper"]
tags: ["zookeeper"]
type: "post"
bg_image: "images/backgrounds/page-title.jpg"
image: "images/blog/zookeeper.png"
---

## 1. Zookeeper 是什么，有什么功能

Zookeeper 是一个典型的分布式数据一致性的解决方案。

Zookeeper 的典型应用场景：

-   数据发布/订阅
-   负载均衡
-   命名服务
-   分布式协调/通知
-   集群管理
-   Master
-   分布式锁
-   分布式队列

## 2. Zookeeper 部署模式

Zookeeper 有两种运行模式：

-   集群模式
-   单机模式

还有一种伪集群模式，在单机模式下模拟集群的 Zookeeper 服务。

## 3. Zookeeper 是如何保证主从节点的状态同步

zookeeper 的核心是原子广播，这个机制保证了各个 server 之间的同步。实现这个机制的协议叫做`zab`协议。`zab` 协议有两种，分别是恢复模式（选主）和广播模式（同步）。
当服务启动或者在领导者崩溃之后，zab 就进入了恢复模式，当领导者被选举出来后，且大多数 server 完成了与 leader 的状态同步之后，恢复模式就结束了。状态同步保证了
leader 和 server 具有相同的系统状态。

## 4. Zookeeper 的通知机制

客户端会对某一个 `znode` 建立一个 `watcher` 事件，当该 `znode` 发生变化时，这些客户端会受到 `Zookeeper` 的通知，然后客户端可以根据 `znode` 变化来做出业务上的改变。ß

## 5. Zookeeper 的分布式锁实现方式

使用 Zookeeper 实现分布式锁的算法流程，假设锁空间根节点为 `/lock`：

1. 客户端连接 Zookeeper，并在 `/lock` 下创建临时的且有序的子节点，第一个客户端对应的子节点为 `/lock/lock-0000000000`，第二个为 `/lock/lock-0000000001`，
   以此类推；
2. 客户端获取 下的子节点列表，判断自己创建的子节点是否为当前子节点列表中序号最小的子节点，如果是则认为获得锁，否则监听刚好在自己之前一位的子节点删除消息，获得子节点
   变更通知后重复此步骤直至获得锁；
3. 执行业务代码；
4. 完成业务流程后，删除对应的子节点释放锁；

## 6. Zookeeper 采用的哪种分布式一致性协议？还有哪些分布式一致性协议

常见的分布式一致性协议有：两阶段提交协议，三阶段提交协议，向量时钟，RWN 协议，`paxos 协议`，`Raft 协议`，zk 采用的是 `paxos 协议`ß。

-   两阶段提交协议(2PC)

    两阶段提交协协议，简称 2PC，是比较常用的解决分布式事务问题的方式，要么所有参与进程都提交事务，要么都取消事务，即实现 ACID 中的原子性(A)的常用手段。

-   三阶段提交协议(2PC)

    3PC 就是在 2PC 的基础上将 2PC 的提交阶段再细分为两个阶段：**预提交阶段**和**提交阶段**。

-   向量时钟

    通过向量空间祖先继承的关系比较，使数据保持最终一致性，这就是向量时钟的基本定义。

-   NWR 协议

    NWR 是一种在分布式存储系统中用于控制一致性级别的一种策略。

-   paxos 协议

    见 [paxos 协议]()

-   Raft 协议

    见 [Raft 协议]()
